#!/usr/bin/env node
import { program } from "commander";

import { normalizeConfig } from "../src/normalizeConfig.js";
import { parseArgs } from "../src/parseArgs.js";
import { runPrompts } from "../src/promptFlow.js";
import { runCreateCommand } from "../src/runCreateCommand.js";
import { log } from "../src/utils/logger.js";

program
  .name("stackboot")
  .description("CLI to create projects from predefined templates")
  .version("2.0.0", "-v, --version", "Show CLI version");

program
  .command("create")
  .argument("[stackVersion]", "Stack and version (e.g., react@18, node)")
  .argument("[projectName]", "Name of the new project")
  .argument(
    "[variant]",
    "React: Variant (e.g., base, auth, admin) / Java: Group Id",
  )
  .helpOption("-h, --help", "Display help for command")
  .action(async (stackVersion, projectName, variant) => {
    try {
      const parsed = parseArgs([stackVersion, projectName, variant]);

      let config;
      if (parsed.isComplete) {
        if (!parsed.stack || !parsed.projectName) {
          throw new Error("Required arguments missing: stack or project name");
        }

        config = normalizeConfig(
          {
            stack: parsed.stack,
            version: parsed.version,
            variant: parsed.variant,
            projectName: parsed.projectName,
            groupId: parsed.groupId,
          },
          "args",
        );
      } else {
        const prompted = await runPrompts(parsed);
        config = normalizeConfig(prompted, "interactive");
      }

      await runCreateCommand(config);
      console.log("âœ¨ Generated by Stack Boot CLI\n");
    } catch (error: any) {
      log.error(error?.message || "Failed to create project.");
    }
  });

program.parse(process.argv);
